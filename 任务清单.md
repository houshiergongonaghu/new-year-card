# 节日贺卡生成器 MVP 任务清单

## 当前状态（已做）
- 项目根目录为 `D:\cursor\shengdanheka`，App Router 在 `app/`，无 `shengdanheka-app` 子项目。
- v0 前端已合并到根项目：`app/page.tsx`、`app/layout.tsx`、`app/globals.css`、`components/`、`lib/`、`public/`。
- `public/` 中 5 张主图已临时用同一张 `image/images.jfif` 复制占位（后续可替换）。
- Supabase 已创建 `generation_logs` 表并用于 IP 限流（SQL 在 `setup.sql`）。
- `/api/generate` 已实现，支持 `MOCK_AI=1` 模拟返回，便于流程验证。

## Phase 1: 项目初始化与环境搭建
- [x] 初始化 Next.js 14+ 项目 (App Router)
- [x] 配置 Tailwind CSS
- [ ] 集成 Google Fonts (Great Vibes/Caveat, Inter)（当前为 Playfair/Geist）
- [ ] 安装必要依赖 (supabase-js, replicate, resend, lucide-react)（已安装 supabase-js/lucide-react；Replicate/Resend 未装）
- [x] 配置 .env.local 环境变量

## Phase 2: Supabase 配置
- [x] 创建 cards 表 (Schema: id, image_url, sender_name, recipient_name, message, created_at)
- [x] 创建 Storage Bucket "cards" (需手动创建)
- [x] 配置存储策略 (public read access) (需手动配置)
- [x] 初始化 Supabase 客户端（API 路由已使用）
- [x] 新增 generation_logs 表 + 索引（用于 IP 限流）

## Phase 3: 前端 UI 开发
- [x] 设计主页粉紫色渐变背景主题
- [x] 实现响应式布局 (桌面左预览右表单，移动端上下布局)
- [x] 创建照片上传组件
- [x] 实现照片预览功能
- [x] 设计 Canvas 预览区域
- [x] 添加节日装饰元素

## Phase 4: AI 生成功能
- [x] 实现 IP 限流 (每个 IP 24 小时最多 2 次)
- [x] 创建 AI 生成 API 路由
- [x] 集成 Replicate API (Image-to-Image)（已接入，需充值后验证真实生成）
- [x] 设置强制 Prompt: "Watercolor Christmas illustration style, festive, warm, masterpiece"
- [x] 配置去噪强度 (0.6-0.75)（当前 prompt_strength=0.7）
- [x] 增加 MOCK_AI 测试模式（MOCK_AI=1）
- [ ] 按正确流程改造：先上传用户图到 Supabase，再用 URL 调用 Replicate，生成后下载并重新上传 Supabase

## Phase 5: Canvas 合成与上传
- [x] 实现 Canvas 图片绘制 (lib/canvas-utils.ts)
- [x] 添加 Great Vibes/Caveat 字体渲染 (使用CDN)
- [x] 消息和发送人姓名位置布局设计 (自动换行 + 固定位置)
- [x] Canvas 导出成 Blob (canvas.toDataURL + Buffer转换)
- [x] 上传到 Supabase Storage (/api/upload API)
- [x] 集成到前端 (app/page.tsx添加生成贺卡按钮)

## Phase 6: 数据存储与邮件发送
- [ ] 创建存储元数据 API action
- [ ] 写入 cards 表
- [ ] 集成 Resend API
- [ ] 实现邮件模板: "{Sender} 为你制作了一张专属贺卡，点击查看：{Link}"

## Phase 7: 查看页与病毒传播
- [ ] 创建 /card/[id] 页面
- [ ] 复用节日主题 CSS
- [ ] 居中显示最终贺卡大图
- [ ] 添加 "我也要做一张" CTA 按钮
- [ ] 点击 CTA 跳转回首页

## Phase 8: 测试与优化
- [ ] 测试完整流程: 上传 -> AI生成 -> Canvas合成 -> Supabase存储 -> 数据库 -> 邮件发送
- [ ] 测试 IP 限流功能
- [ ] 移动端响应式测试
- [ ] 性能优化
- [ ] Bug 修复

## 重要提示
- 无需用户登录系统 (Auth)
- 优先移动端体验
- 成本控制: 注意 Replicate API / Resend API 调用次数
- PRD 需求有变化时同步更新 `CLAUDE.md` 与 `任务清单.md`
